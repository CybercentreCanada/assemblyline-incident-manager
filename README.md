# Assemblyline incident manager
This repository contains three Python scripts used for bulk triaging file using Assemblyline.
1. Submitter (`al-incident-submitter`): pushes files from a directory to an Assemblyline instance for analysis.
2. Result analyzer (`al-incident-analyzer`): pulls the submissions from the Assemblyline instance and reports on if the submissions are safe/unsafe.
3. Downloader (`al-incident-downloader`): downloads files submitted to Assemblyline that are under a certain score threshold, matching the folder structure of the files as they were submitted.

# Prerequisites
- You will need the URL of an Assemblyline instance that you have an account on, for best results make sure it is loaded with your best YARA rules, Sandboxes etc. 
  - Want to create your own Assemblyline instance? [HOW-TO](https://cybercentrecanada.github.io/assemblyline4_docs/installation/deployment/)
- You will need two API keys generated by Assemblyline, ideally one with read access and another with write access. 
  - The Write-only key will be used for the "Submitter" and the Read-only key will be used for the "Result Analysis" and the "Downloader".
  - This helps in the context of incident response to reduce the exposure of your Assemblyline instance.

# Installation
## Linux
- Install the following packages: `libffi-dev`, `libssl-dev`
  - (APT) `sudo apt-get install libffi-dev libssl-dev python3`
  - (YUM) `sudo yum install libffi-dev libssl-dev python3`
- Upgrade PIP: `python3 -m pip install --upgrade pip`
- `python3 -m pip install assemblyline-incident-manager`

## Windows
- Download and install the most recent Python .msi installer from https://www.python.org/downloads/release. 
- Upgrade PIP: `python -m pip install --upgrade pip`
- `python -m pip install assemblyline-incident-manager`

# Usage
## Submitter
```
al-incident-submitter --help
usage: al-incident-submitter [-h] [--config CONFIG] [--server SERVER] [--insecure] 
                             [-u "user"] [-k "MY_RANDOM_API_KEY"] [--incident-num INCIDENT_NUM] 
                             [-t] [--classification CLASSIFICATION] [--ttl TTL]
                             [--services SERVICES] [--resubmit-dynamic] [-f] [--alert] [--threads THREADS]
                             [--dedup-hashes] [--priority PRIORITY]
                             path [path ...]

Assemblyline Incident Submitter

positional arguments:
  path                  Path to process.

options:
  -h, --help            show this help message and exit
  --config CONFIG       Read options from the specified TOML file.
  --server SERVER       The target URL that hosts Assemblyline.
  --insecure            Ignore SSL errors (insecure!)
  -u "user", --user "user"
                        Your Assemblyline account username.
  -k "MY_RANDOM_API_KEY", --apikey "MY_RANDOM_API_KEY"
                        A path to a file that contains only your Assemblyline account API key. NOTE that this API key requires write access.
  --incident-num INCIDENT_NUM
                        The incident number that each file is associated with.
  -t, --is_test         A flag that indicates that you're running a test.
  --classification CLASSIFICATION
                        TLP for the files in the path.
  --ttl TTL             Days before submissions are removed.
  --services SERVICES   Assemblyline Service Selection.
  --resubmit-dynamic    Resubmit files over threshold (default 500).
  -f, --fresh           Ignore file list for resuming previous submission.
  --alert               Generate alerts for this submission.
  --threads THREADS     Number of threads that will ingest files to Assemblyline.
  --dedup-hashes        Do not submit files with identical hashes for this submission.
  --priority PRIORITY   Set the priority of the submission.

Example 1:
al-incident-submitter --url="https://<domain-of-Assemblyline-instance>" \
    --username="<user-name>" --apikey="/path/to/file/containing/apikey" \
    --classification="<classification>" --service_selection="<service-name>,<service-name>" \ 
    --incident_num=123 "/path/to/scan"

Example 2:
al-incident-submitter --config incident_config.toml --incident_num=123 "/path/to/scan"
```

## Analyzer
```
al-incident-analyzer --help
usage: al-incident-analyzer [-h] [--config CONFIG] [--server SERVER] [--insecure] 
                            [-u "user"] [-k "MY_RANDOM_API_KEY"] [--incident-num INCIDENT_NUM] 
                            [-t] [--min-score MIN_SCORE]

Assemblyline Incident Analyzer

options:
  -h, --help            show this help message and exit
  --config CONFIG       Read options from the specified TOML file.
  --server SERVER       The target URL that hosts Assemblyline.
  --insecure            Ignore SSL errors (insecure!)
  -u "user", --user "user"
                        Your Assemblyline account username.
  -k "MY_RANDOM_API_KEY", --apikey "MY_RANDOM_API_KEY"
                        A path to a file that contains only your Assemblyline account API key. NOTE that this API key requires write access.
  --incident-num INCIDENT_NUM
                        The incident number that each file is associated with.
  -t, --is_test         A flag that indicates that you're running a test.
  --min-score MIN_SCORE
                        The minimum score for files that we want to query from Assemblyline.

Example 1:
al-incident-analyzer --url="https://<domain-of-Assemblyline-instance>" \
    --user="<user-name>" --apikey="/path/to/file/containing/apikey" --incident_num=123

Example 2:
al-incident-analyzer --config incident_config.toml --incident_num=123 --min_score=100
```

Now check the `report.csv` file that was created. This file will contain what files are safe/unsafe.

## Downloader
```
al-incident-downloader --help
usage: al-incident-downloader [-h] [--config CONFIG] [--server SERVER] [--insecure] 
                              [-u "user"] [-k "MY_RANDOM_API_KEY"] [--incident-num INCIDENT_NUM] 
                              [-t] [--max-score MAX_SCORE] --download-path DOWNLOAD_PATH
                              [--upload-path UPLOAD_PATH] [--threads THREADS]


Assemblyline Incident Downloader

options:
  -h, --help            show this help message and exit
  --config CONFIG       Read options from the specified TOML file.
  --server SERVER       The target URL that hosts Assemblyline.
  --insecure            Ignore SSL errors (insecure!)
  -u "user", --user "user"
                        Your Assemblyline account username.
  -k "MY_RANDOM_API_KEY", --apikey "MY_RANDOM_API_KEY"
                        A path to a file that contains only your Assemblyline account API key. NOTE that this API key requires write access.
  --incident-num INCIDENT_NUM
                        The incident number that each file is associated with.
  -t, --is_test         A flag that indicates that you're running a test.
  --max-score MAX_SCORE
                        The maximum score for files that we want to download from Assemblyline.
  --download-path DOWNLOAD_PATH
                        The path to the folder that we will download files to.
  --upload-path UPLOAD_PATH
                        The base path from which the files were ingested from on the compromised system.
  --threads THREADS     Number of threads that will download files from Assemblyline.

Example 1:
al-incident-downloader --url="https://<domain-of-Assemblyline-instance>" \
    --username="<user-name>" --apikey="/path/to/file/containing/apikey" --incident_num=123 \
    --max_score=100 --download_path=/path/to/where/you/want/downloads \
    --upload_path=/path/from/where/files/were/uploaded/from

Example 2:
al-incident-downloader --config incident_config.toml --incident_num=123 --max_score=100 \
    --download_path=/path/to/where/you/want/downloads --upload_path=/path/from/where/files/were/uploaded/from
```

If you check the download path you supplied, you should have all files downloaded there.

----------------------------

# L'assistant à la réponse aux incidents d'Assemblyline
Ce répertoire contient trois scripts Python pour assisté le triage de grande quantité de fichiers avec Assemblyline.
1. Soumission (`al-incident-submitter`): envoi les fichiers contenu dans un dossier vers une instance Assemblyline pour l'analyze.
2. Résultats d'analyse (`al-incident-analyzer`): analyse les soumissions et génère un rapport.
3. Téléchargeur (`al-incident-downloader`): télécharge les fichiers sous un certain pointage en préservant la structure original.

# Prérequis
- Vous aurez besoin d'un instance d'Assemblyline à jour et avec vos meilleurs règles YARA, "Sandboxes" etc.
  - Voici comment crée vôtre propre instance: [LIEN](https://cybercentrecanada.github.io/assemblyline4_docs_fr/docs/installation.html)
- Nous vous recommandons d'utilisé deux clé d'api, un `write only` et une `read only`
  - La clé `Write-only` sera utilisé pour soumettre vos fichier avec le script "Submitter" et la clé `Read-only` sera pour "Result Analysis" et le "Downloader".
  - Cette séparation aidera a securisé vôtre instance Assemblyline dans un context de réponse aux incidents

# Installation
## Linux
- Installé les packages suivants: `libffi-dev`, `libssl-dev`
    - (APT) `sudo apt-get install libffi-dev libssl-dev python3`
    - (YUM) `sudo yum install libffi-dev libssl-dev python3`
- Mise à jour de PIP: `python3 -m pip install --upgrade pip`
- `python3 -m pip install assemblyline-incident-manager`

## Windows
- Installé Python 3: https://www.python.org/downloads/release. 
- Mise à jour de PIP: `python -m pip install --upgrade pip`
- `python -m pip install assemblyline-incident-manager`

# Utilisation
## Submitter
```
al-incident-submitter --help
usage: al-incident-submitter [-h] [--config CONFIG] [--server SERVER] [--insecure] 
                             [-u "user"] [-k "MY_RANDOM_API_KEY"] [--incident-num INCIDENT_NUM] 
                             [-t] [--classification CLASSIFICATION] [--ttl TTL]
                             [--services SERVICES] [--resubmit-dynamic] [-f] [--alert] [--threads THREADS]
                             [--dedup-hashes] [--priority PRIORITY]
                             path [path ...]

Assemblyline Incident Submitter

positional arguments:
  path                  Path to process.

options:
  -h, --help            show this help message and exit
  --config CONFIG       Read options from the specified TOML file.
  --server SERVER       The target URL that hosts Assemblyline.
  --insecure            Ignore SSL errors (insecure!)
  -u "user", --user "user"
                        Your Assemblyline account username.
  -k "MY_RANDOM_API_KEY", --apikey "MY_RANDOM_API_KEY"
                        A path to a file that contains only your Assemblyline account API key. NOTE that this API key requires write access.
  --incident-num INCIDENT_NUM
                        The incident number that each file is associated with.
  -t, --is_test         A flag that indicates that you're running a test.
  --classification CLASSIFICATION
                        TLP for the files in the path.
  --ttl TTL             Days before submissions are removed.
  --services SERVICES   Assemblyline Service Selection.
  --resubmit-dynamic    Resubmit files over threshold (default 500).
  -f, --fresh           Ignore file list for resuming previous submission.
  --alert               Generate alerts for this submission.
  --threads THREADS     Number of threads that will ingest files to Assemblyline.
  --dedup-hashes        Do not submit files with identical hashes for this submission.
  --priority PRIORITY   Set the priority of the submission.

Example 1:
al-incident-submitter --url="https://<domain-of-Assemblyline-instance>" \
    --username="<user-name>" --apikey="/path/to/file/containing/apikey" \
    --classification="<classification>" --service_selection="<service-name>,<service-name>" \ 
    --incident_num=123 "/path/to/scan"

Example 2:
al-incident-submitter --config incident_config.toml --incident_num=123 "/path/to/scan"
```

## Analyzer
```
al-incident-analyzer --help
usage: al-incident-analyzer [-h] [--config CONFIG] [--server SERVER] [--insecure] 
                            [-u "user"] [-k "MY_RANDOM_API_KEY"] [--incident-num INCIDENT_NUM] 
                            [-t] [--min-score MIN_SCORE]

Assemblyline Incident Analyzer

options:
  -h, --help            show this help message and exit
  --config CONFIG       Read options from the specified TOML file.
  --server SERVER       The target URL that hosts Assemblyline.
  --insecure            Ignore SSL errors (insecure!)
  -u "user", --user "user"
                        Your Assemblyline account username.
  -k "MY_RANDOM_API_KEY", --apikey "MY_RANDOM_API_KEY"
                        A path to a file that contains only your Assemblyline account API key. NOTE that this API key requires write access.
  --incident-num INCIDENT_NUM
                        The incident number that each file is associated with.
  -t, --is_test         A flag that indicates that you're running a test.
  --min-score MIN_SCORE
                        The minimum score for files that we want to query from Assemblyline.

Example 1:
al-incident-analyzer --url="https://<domain-of-Assemblyline-instance>" \
    --user="<user-name>" --apikey="/path/to/file/containing/apikey" --incident_num=123

Example 2:
al-incident-analyzer --config incident_config.toml --incident_num=123 --min_score=100
```

Regardez le rapport dans `report.csv`. Ce fichier contient un rapport des détections.

## Downloader
```
al-incident-downloader --help
usage: al-incident-downloader [-h] [--config CONFIG] [--server SERVER] [--insecure] 
                              [-u "user"] [-k "MY_RANDOM_API_KEY"] [--incident-num INCIDENT_NUM] 
                              [-t] [--max-score MAX_SCORE] --download-path DOWNLOAD_PATH
                              [--upload-path UPLOAD_PATH] [--threads THREADS]


Assemblyline Incident Downloader

options:
  -h, --help            show this help message and exit
  --config CONFIG       Read options from the specified TOML file.
  --server SERVER       The target URL that hosts Assemblyline.
  --insecure            Ignore SSL errors (insecure!)
  -u "user", --user "user"
                        Your Assemblyline account username.
  -k "MY_RANDOM_API_KEY", --apikey "MY_RANDOM_API_KEY"
                        A path to a file that contains only your Assemblyline account API key. NOTE that this API key requires write access.
  --incident-num INCIDENT_NUM
                        The incident number that each file is associated with.
  -t, --is_test         A flag that indicates that you're running a test.
  --max-score MAX_SCORE
                        The maximum score for files that we want to download from Assemblyline.
  --download-path DOWNLOAD_PATH
                        The path to the folder that we will download files to.
  --upload-path UPLOAD_PATH
                        The base path from which the files were ingested from on the compromised system.
  --threads THREADS     Number of threads that will download files from Assemblyline.

Example 1:
al-incident-downloader --url="https://<domain-of-Assemblyline-instance>" \
    --username="<user-name>" --apikey="/path/to/file/containing/apikey" --incident_num=123 \
    --max_score=100 --download_path=/path/to/where/you/want/downloads \
    --upload_path=/path/from/where/files/were/uploaded/from

Example 2:
al-incident-downloader --config incident_config.toml --incident_num=123 --max_score=100 \
    --download_path=/path/to/where/you/want/downloads --upload_path=/path/from/where/files/were/uploaded/from
```

Tous les fichiers sans détections seront téléchargé dans le dossier choisi.

